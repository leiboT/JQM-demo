<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="stylesheet" href="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.css">
    <script src="//code.jquery.com/jquery-1.8.3.min.js"></script>
    <script>
      $(document).bind("mobileinit", function () {
        $.mobile.page.prototype.options.headerTheme = "c";
        $.mobile.page.prototype.options.contentTheme    = "c";
        $.mobile.page.prototype.options.footerTheme = "c";
      });
    </script>
    <script src="//code.jquery.com/mobile/1.3.2/jquery.mobile-1.3.2.min.js"></script>
</head>
<body>
    <div data-role="page" data-title="列车查询时刻表" id="searchPage">
        <div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <h1>列车查询时刻表</h1>
        </div>
        <div data-role="content">
            <form action="#" method="post">
                <div data-role="fieldcontain">
                    <label for="start-station">发车站</label>
                    <input type="text" name="start-station" id="start-station">
                    <label for="end-station">到达站</label>
                    <input type="text" name="end-station" id="end-station">
                    <label for="train-number">车次</label>
                    <input type="text" name="train-number" id="train-number">
                </div>
                <input type="button" value="查询" id="searchBtn">
                <div data-role="popup" id="noDataPopup">
                    <p></p>
                </div>
            </form>
            <ul data-role="listview" data-inset="true" id="trainList"></ul>
        </div>
        <div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <div data-role="navbar">
                <ul>
                    <li><a href="#searchPage" class="ui-btn-active ui-state-persist" data-icon="home">首页</a></li>
                    <li><a href="#collectPage" data-icon="star" data-transition="flip">收藏</a></li>
                    <li><a href="#settingPage" data-icon="gear" data-transition="flip">设置</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div data-role="page" id="detailPage">
        <div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="c" id="detailPageHeader">
            <h1>车次详情</h1>
            <a href="#" data-role="button" data-icon="star" data-iconpos="right" id="collectBtn">收藏</a>
            <a href="#" data-role="button" data-icon="star" data-iconpos="right" style="display: none" id="cancelCollectBtn">取消收藏</a>
            <div data-role="popup" id="collectPopup" data-theme="e">
                <p></p>
            </div>
        </div>
        <div data-role="content">
            <h2 id="trainCode">G111次</h2>
            <table data-role="table" data-mode="reflow" class="ui-responsive ui-shadow table-stroke" id="detailTable" style="display: table">
                <thead>
                    <tr>
                        <th>站名</th>
                        <th>到站时间</th>
                        <th>出发时间</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <a href="#" data-rel="back" data-role="button">返回</a>
        </div>
    </div>
    <div data-role="page" id="collectPage">
        <div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <h1>我的收藏</h1>
        </div>
        <div data-role="content">
            <ul data-role="listview" data-inset="true" id="collectList"></ul>
        </div>
        <div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <div data-role="navbar">
                <ul>
                    <li><a href="#searchPage" data-icon="home" data-transition="flip">首页</a></li>
                    <li><a href="#collectPage" class="ui-btn-active ui-state-persist" data-icon="star" >收藏</a></li>
                    <li><a href="#settingPage" data-icon="gear" data-transition="flip">设置</a></li>
                </ul>
            </div>
        </div>
    </div>
    <div data-role="page" id="settingPage">
        <div data-role="header" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <h1>设置</h1>
        </div>
        <div data-role="content">
            <form action="#">
                <div data-role="fieldcontain">
                    <fieldset data-role="collapsible" data-collapsed-icon="arrow-d" data-expanded-icon="arrow-u" data-mini="true">
                        <legend>这里有份问卷!</legend>
                        <label for="name">全名：</label>
                        <input type="text" name="text" id="name">
                        <fieldset data-role="controlgroup" data-type="horizontal">
                            <legend>您的性别:</legend>
                            <label for="male">男</label>
                            <input type="radio" name="gender" id="male" value="male">
                            <label for="female">女</label>
                            <input type="radio" name="gender" id="female" value="female" checked>
                        </fieldset>
                        <p>喜爱的颜色：</p>
                        <div data-role="controlgroup" data-type="horizontal">
                            <label for="red">红色</label>
                            <input type="checkbox" name="favcolor" id="red" value="red">
                            <label for="green">绿色</label>
                            <input type="checkbox" name="favcolor" id="green" value="green">
                            <label for="blue">蓝色</label>
                            <input type="checkbox" name="favcolor" id="blue" value="blue">
                        </div>
                        <label for="age">年龄:</label>
                        <input type="range" name="age" id="age" value="18" step="1" min="1" max="80" data-highlight="true">
                    </fieldset>
                </div>
            </form>
        </div>
        <div data-role="footer" data-position="fixed" data-tap-toggle="false" data-theme="c">
            <div data-role="navbar">
                <ul>
                    <li><a href="#searchPage" data-icon="home" data-transition="flip">首页</a></li>
                    <li><a href="#collectPage" data-icon="star" data-transition="flip">收藏</a></li>
                    <li><a href="#settingPage" class="ui-btn-active ui-state-persist" data-icon="gear">置</a></li>
                </ul>
            </div>
        </div>
    </div>
    <script>

      let collectArray = [];
      if(localStorage.getItem('collect')){
        console.log(collectArray = localStorage.getItem('collect').split(','));
      }
      let urlPre = '//leibo.group/xml/';
      // 通过发车站和终点站查询火车时刻表
      let startEndStationUrl = 'ws.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getStationAndTimeByStationName?UserID=';
      // 通过火车车次查询本火车时刻表
      let likeTrainCodeUrl = 'ws.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getStationAndTimeDataSetByLikeTrainCode?UserID=';
      // 通过火车车次查询列车经由车站明细
      let trainCodeUrl = 'ws.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getDetailInfoByTrainCode?UserID=';
      let trainList = $("#trainList");
      // 可查询
      function canSearch(){
        let _data = {};
        let _url = '';
        if(!$("#train-number").val()){
          _data.StartStation = $("#start-station").val();
          _data.ArriveStation = $("#end-station").val();
          _url = startEndStationUrl;
        }else {
          _data.TrainCode = $("#train-number").val();
          _url = likeTrainCodeUrl;
        }
        $.get(urlPre + _url,_data, function (data) {
          let timeTable = $(data).find('TimeTable');
          let _html = '';
          if(timeTable.find('FirstStation').text() === '数据没有被发现'){
            trainList.html('');
            $("#noDataPopup>p").text('没有数据');
            $("#noDataPopup").popup('open');
          }else {
            timeTable.each(function (k, v){
              let _this = $(v);
              if(k>10) return;
              _html += `
                <li>
                    <a href="#" data-no='${_this.find('TrainCode').text()}'>
                        <h2>${_this.find('TrainCode').text()}次</h2>
                        <p>${_this.find('FirstStation').text()} - ${_this.find('LastStation').text()}</p>
                        <p>用时：${_this.find('UseDate').text()}</p>
                        <p class="ui-li-aside">${_this.find('StartTime').text()}开</p>
                    </a>
                </li>
              `;
            });
            trainList.html(_html);
            trainList.listview('refresh');
            $("#searchBtn").attr('disabled', false);
            $.mobile.loading('hide');
          }
        })
      }
      // 不可查询
      function forbidSearch(){
        $("#noDataPopup>p").text('请输入查询条件');
        $("#noDataPopup").popup('open');
      }

      // 获取车次列表
      function getTrainList(){
        if($("#train-number").val() || $("#start-station").val() && $("#end-station").val()){
          $(this).attr('disabled', true);
          $.mobile.loading("show");
          canSearch();
        }else {
          forbidSearch();
        }
      }
      // 获取车次详细信息
      let isAjax = false;
      function getTrainCodeInfo(self){
        if(isAjax) return;
        isAjax = true;
        $.mobile.loading('show');
        let _no = $(self).attr('data-no');
        $.get(urlPre + trainCodeUrl, {TrainCode: _no}, function (data) {
          let trainDetailInfo = $(data).find('TrainDetailInfo');
          let _tr = '';
          trainDetailInfo.each(function (k, v) {
            let _v = $(v);
            _tr += `
            <tr>
              <td>${_v.find('TrainStation').text()}</td>
              <td>${_v.find('ArriveTime').text()}</td>
              <td>${_v.find('StartTime').text()}</td>
            </tr>
            `;
          });
          $("#detailPageHeader>a").attr('data-no', _no);
          $("#trainCode").text(_no + '次');
          $("#detailTable>tbody").html(_tr);
          $.mobile.loading('hide');
          $.mobile.changePage("#detailPage", {
            transition: "flip",
            changeHash: true
          });
          isAjax = false;
        })
      }

      // 初始化
      function searchPageBindEvent(){
        // 查询车次列表
        $("#searchBtn").on("click", getTrainList);
        // 车次详细信息
        trainList.on("click", "a", function (){
          $("#cancelCollectBtn").hide();
          $("#collectBtn").show();
          getTrainCodeInfo(this)
        });
      }

      // 详情页进行收藏操作
      function collect(){
        $('#collectPopup>p').text('收藏成功');
        collectArray.push($(this).attr('data-no'));
        localStorage.setItem('collect', collectArray);
        $('#collectPopup').popup('open');
      }
      function cancelCollect(){
        let _self = $(this);
        collectArray = collectArray.filter(function (v) {
          return v !== _self.attr('data-no');
        });
        localStorage.setItem('collect', collectArray);
        $('#collectPopup>p').text('取消收藏成功');
        $('#collectPopup').popup('open');
        setTimeout(function () {
          $.mobile.changePage('#collectPage', {
            transition: 'flip'
          })
        },350)
      }
      // 取消收藏
      $("#cancelCollectBtn").on('click', cancelCollect);
      // 收藏
      $("#collectBtn").on('click', collect);

      // 搜索页初始化
      $(document).on('pageinit', '#searchPage', function () {
        searchPageBindEvent();
      });


      // 我的收藏
      $(document).on('pageshow', '#collectPage', function () {
        if(collectArray.length>0){
          $.mobile.loading('show');
          let _html = '';
          $(collectArray).each(function (k ,v){
            $.get(urlPre + likeTrainCodeUrl, {TrainCode: v}, function (data) {
              let timeTable = $(data).find('TimeTable');
              timeTable.each(function (k1, v1){
                let _this = $(v1);
                _html += `
                <li>
                    <a href="#" data-no='${_this.find('TrainCode').text()}'>
                        <h2>${_this.find('TrainCode').text()}次</h2>
                        <p>${_this.find('FirstStation').text()} - ${_this.find('LastStation').text()}</p>
                        <p>用时：${_this.find('UseDate').text()}</p>
                        <p class="ui-li-aside">${_this.find('StartTime').text()}开</p>
                    </a>
                </li>
              `;
              });
              $("#collectList").html(_html);
              $("#collectList").listview('refresh');
              $.mobile.loading('hide');
            })
          });
        }else {
          $("#collectList").html('<li style="text-align: center;">暂无收藏</li>');
        }
      });

      // 我的收藏查看详情页
      $("#collectList").on('tap', 'a', function () {
        $("#cancelCollectBtn").show();
        $("#collectBtn").hide();
        getTrainCodeInfo(this)
      });

      // 设置
      $(document).on('pageinit', '#settingPage', function () {
        $("#themeToggle").on('tap', 'li', function () {
          console.log(this);
          let _self = $(this);
        })
      });
    </script>
</body>
</html>